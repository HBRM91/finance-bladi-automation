# .github/workflows/finance-bladi-daily.yml
name: Finance Bladi - Daily Data Pipeline

on:
  # Planification quotidienne 7:00 UTC (8:00 Maroc)
  schedule:
    - cron: '0 7 * * 1-5'  # Lundi √† Vendredi √† 07:00 UTC
  # Permet de d√©clencher manuellement depuis l'interface GitHub
  workflow_dispatch:
    inputs:
      test-mode:
        description: 'Run in test mode'
        required: false
        default: 'false'

# Permissions n√©cessaires
permissions:
  contents: write
  actions: read

jobs:
  collect-and-process:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # D√©pendances principales
        pip install yfinance pandas requests gspread oauth2client selenium beautifulsoup4
        
    - name: üîß Setup Chrome for Selenium
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver
        
    - name: üìä Run Data Collection
      id: collect
      run: |
        echo "üïê D√©but de la collecte: $(date)"
        echo "üìÅ Workspace: $GITHUB_WORKSPACE"
        
        # Ex√©cuter le script principal
        cd "$GITHUB_WORKSPACE"
        python src/main.py
        
        # V√©rifier si des fichiers ont √©t√© cr√©√©s
        if ls downloads/*.json 1> /dev/null 2>&1; then
          echo "‚úÖ Donn√©es collect√©es avec succ√®s"
          echo "data_collected=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Aucun fichier de donn√©es g√©n√©r√©"
          echo "data_collected=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: üíæ Save Data to Repository
      if: steps.collect.outputs.data_collected == 'true'
      run: |
        echo "üíæ Sauvegarde des donn√©es dans le d√©p√¥t..."
        
        # Configurer git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        
        # Cr√©er dossier data s'il n'existe pas
        mkdir -p historical_data
        
        # Copier le dernier fichier JSON
        LATEST_FILE=$(ls -t downloads/finance_bladi_data_*.json | head -1)
        DATE_TODAY=$(date '+%Y%m%d')
        
        if [ -f "$LATEST_FILE" ]; then
          # Copier pour archivage
          cp "$LATEST_FILE" "historical_data/data_$DATE_TODAY.json"
          
          # Mettre √† jour le fichier "latest"
          cp "$LATEST_FILE" "historical_data/latest.json"
          
          # Commit et push
          git add historical_data/
          git commit -m "üìà Data update $DATE_TODAY [skip ci]"
          git push
          
          echo "‚úÖ Donn√©es sauvegard√©es: historical_data/data_$DATE_TODAY.json"
        else
          echo "‚ö†Ô∏è  Aucun fichier de donn√©es trouv√©"
        fi
        
    - name: üì§ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: market-data-${{ github.run_number }}
        path: |
          downloads/
          historical_data/latest.json
        retention-days: 7
        
    - name: üìß Notification on Failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{secrets.MAIL_USERNAME}}
        password: ${{secrets.MAIL_PASSWORD}}
        subject: "‚ùå Finance Bladi Pipeline Failed"
        to: votre-email@example.com
        from: GitHub Actions
        body: "Workflow failed: ${{ github.run_id }}\nView logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
    - name: üéâ Success Notification
      if: success()
      run: |
        echo "‚úÖ Pipeline ex√©cut√© avec succ√®s √† $(date)"
        echo "üîó Voir les artefacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
