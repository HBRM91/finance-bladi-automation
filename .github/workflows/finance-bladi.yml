# .github/workflows/daily-automation.yml
name: Daily Finance Bladi Automation

on:
  # 1Ã¨re tentative : 8h UTC = 9h Maroc (aprÃ¨s publication BKAM)
  schedule:
    - cron: '0 7 * * 1-5'  # Lundi Ã  Vendredi Ã  07:00 UTC
  # DÃ©clenchement manuel depuis GitHub
  workflow_dispatch:
  # DÃ©clenchement par webhook
  repository_dispatch:
    types: [trigger_daily]

jobs:
  run-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install -r requirements.txt
        pip install yfinance pandas requests gspread oauth2client
        
    - name: ğŸ”‘ Setup Google Sheets credentials
<<<<<<< HEAD
      run: |
        echo "=== DEBUG: Checking secret ==="
        echo "Secret name: GOOGLE_CREDENTIALS"
        echo "Secret length: ${#GOOGLE_CREDENTIALS} characters"
        
        # Write the secret to file
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
        
        # Validate the JSON
        echo "=== Validating credentials.json ==="
        if python -c "import json, sys; json.load(open('credentials.json')); print('âœ… JSON is valid')"; then
          echo "âœ… Credentials file created successfully"
          echo "File size: $(wc -c < credentials.json) bytes"
          echo "First line: $(head -1 credentials.json | cut -c1-50)..."
        else
          echo "âŒ ERROR: Invalid JSON in credentials"
          echo "File content preview:"
          head -5 credentials.json
          exit 1
        fi
        
    - name: ğŸ§ª Test credentials (quick check)
      run: |
        echo "=== Testing credentials ==="
        python -c "
import json, os
try:
    with open('credentials.json', 'r') as f:
        data = json.load(f)
    print(f'âœ… Valid JSON. Service account: {data.get(\"client_email\", \"NOT FOUND\")}')
    print(f'âœ… Project ID: {data.get(\"project_id\", \"NOT FOUND\")}')
    print(f'âœ… Private key present: {\"YES\" if data.get(\"private_key\") else \"NO\"}')
except Exception as e:
    print(f'âŒ Error: {e}')
    exit(1)
"
        
    - name: ğŸš€ Run Finance Bladi Automation
      env:
        SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
      run: |
        echo "ğŸ• Starting automation at $(date)"
        echo "Environment variables:"
        echo "SPREADSHEET_ID: $SPREADSHEET_ID"
        echo "Credentials file: $(ls -la credentials.json)"
        python main.py
=======
      run: |
        echo '${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}' > credentials.json
        
    - name: ğŸš€ Run Finance Bladi Automation
      run: |
        echo "ğŸ• Starting automation at $(date)"
        python src/main.py
>>>>>>> 36ce851 (Add GitHub Actions workflow)
        echo "âœ… Automation completed at $(date)"
        
    - name: ğŸ’¾ Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: finance-bladi-data-${{ github.run_id }}
        path: |
          data/
          logs/
<<<<<<< HEAD
        retention-days: 7
=======
        retention-days: 7
>>>>>>> 36ce851 (Add GitHub Actions workflow)
